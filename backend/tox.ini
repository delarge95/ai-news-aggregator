# Tox configuration for AI News Aggregator
# Comprehensive testing automation across Python versions and environments

[tox]
# Python versions to test against
envlist = 
    py311-unit
    py311-integration
    py311-coverage
    py311-performance
    lint
    type-check
    security-check
    docs-build

# Skip missing Python interpreters
skip_missing_interpreters = True

# Minimum tox version
minversion = 4.0

[testenv]
# Base test environment configuration
description = Run unit tests
deps = 
    pytest>=7.4.0
    pytest-asyncio>=0.21.0
    pytest-cov>=4.1.0
    pytest-mock>=3.11.0
    httpx>=0.24.0
    sqlalchemy>=2.0.0
    alembic>=1.11.0
    asyncpg>=0.27.0

# Environment variables
setenv =
    TESTING = true
    DATABASE_URL = sqlite+aiosqlite:///:memory:
    REDIS_URL = redis://localhost:6379/15
    OPENAI_API_KEY = test-key-for-testing
    CELERY_BROKER_URL = redis://localhost:6379/15
    CELERY_RESULT_BACKEND = redis://localhost:6379/15
    JWT_SECRET_KEY = test-jwt-secret-key
    DEBUG = false
    AI_ANALYSIS_TIMEOUT = 10
    CACHE_TTL = 300

# Test commands
commands = 
    pytest tests/ -m "unit or not slow" --cov=app --cov-report=term-missing --cov-report=xml:{toxworkdir}/coverage-{envname}.xml

[testenv:py311-unit]
# Unit tests only
description = Run unit tests only
commands = 
    pytest tests/ -m unit --cov=app --cov-branch --cov-report=term-missing --cov-report=html:{toxworkdir}/htmlcov-unit

[testenv:py311-integration]
# Integration tests only
description = Run integration tests
deps = 
    {[testenv]deps}
    redis>=4.6.0
    celery>=5.3.0
    faker>=19.3.0

commands = 
    pytest tests/ -m integration --cov=app --cov-append --cov-report=term-missing

[testenv:py311-coverage]
# Full coverage report
description = Generate comprehensive coverage report
deps = 
    {[testenv]deps}
    coverage[toml]>=7.2.0
    coverage-badge>=1.1.0

commands_pre =
    coverage erase

commands = 
    pytest tests/ --cov=app --cov-branch --cov-report=term-missing --cov-report=html:{toxworkdir}/htmlcov --cov-report=xml:{toxworkdir}/coverage.xml --cov-report=json:{toxworkdir}/coverage.json

commands_post =
    coverage-badge -o {toxworkdir}/coverage-badge.svg
    coverage report --show-missing

[testenv:py311-performance]
# Performance tests
description = Run performance benchmarks
deps = 
    {[testenv]deps}
    pytest-benchmark>=4.0.0
    memory-profiler>=0.61.0
    psutil>=5.9.0

commands = 
    pytest tests/ -m performance --benchmark-only --benchmark-json={toxworkdir}/benchmark.json --benchmark-histogram={toxworkdir}/benchmark

[testenv:lint]
# Code linting
description = Run code linting
deps = 
    flake8>=6.0.0
    flake8-docstrings>=1.7.0
    flake8-import-order>=0.18.0
    flake8-bugbear>=23.7.0
    flake8-comprehensions>=3.14.0
    flake8-simplify>=0.20.0
    black>=23.7.0
    isort>=5.12.0

commands =
    black --check --diff app/ tests/
    isort --check-only --diff app/ tests/
    flake8 app/ tests/ --max-line-length=100 --extend-ignore=E203,W503

[testenv:format]
# Auto-format code
description = Format code automatically
deps = 
    black>=23.7.0
    isort>=5.12.0

commands =
    black app/ tests/
    isort app/ tests/

[testenv:type-check]
# Type checking
description = Run type checking with mypy
deps = 
    mypy>=1.5.0
    types-requests>=2.31.0
    types-redis>=4.6.0
    types-PyYAML>=6.0.0

commands =
    mypy app/ --ignore-missing-imports --show-error-codes

[testenv:security-check]
# Security analysis
description = Run security analysis
deps = 
    bandit>=1.7.5
    safety>=2.3.0

commands =
    bandit -r app/ -f json -o {toxworkdir}/security-report.json
    safety check --json --output {toxworkdir}/safety-report.json

[testenv:docs-build]
# Documentation build
description = Build documentation
deps = 
    sphinx>=7.1.0
    sphinx-rtd-theme>=1.3.0
    sphinx-autodoc-typehints>=1.24.0

commands =
    sphinx-build -b html docs/ {toxworkdir}/docs

[testenv:clean]
# Clean build artifacts
description = Clean build artifacts
deps = 
skip_install = true

commands =
    python -c "import shutil; shutil.rmtree('htmlcov', ignore_errors=True)"
    python -c "import shutil; shutil.rmtree('.coverage', ignore_errors=True)"
    python -c "import os; [os.remove(f) for f in os.listdir('.') if f.endswith('.xml') or f.endswith('.json')]"
    find . -name "*.pyc" -delete
    find . -name "__pycache__" -type d -exec rm -rf {} + 2>/dev/null || true

[testenv:test-all]
# Run all tests
description = Run complete test suite
deps = 
    {[testenv:py311-coverage]deps}
    {[testenv:lint]deps}
    {[testenv:type-check]deps}
    {[testenv:security-check]deps}

commands_pre =
    {[testenv:clean]commands}

commands =
    {[testenv:lint]commands}
    {[testenv:type-check]commands}
    {[testenv:security-check]commands}
    {[testenv:py311-coverage]commands}

[testenv:ci]
# CI/CD environment
description = CI/CD testing environment
deps = 
    {[testenv:py311-coverage]deps}

commands =
    pytest tests/ --cov=app --cov-branch --cov-report=xml --cov-report=term-missing --cov-fail-under=80 -v

[testenv:benchmark]
# Benchmark comparison
description = Run benchmark comparisons
deps = 
    {[testenv:py311-performance]deps}

commands =
    pytest tests/ -m performance --benchmark-only --benchmark-compare=master --benchmark-compare-fail=mean:5%

# Configuration sections
[flake8]
# Flake8 configuration
max-line-length = 100
extend-ignore = 
    E203,  # whitespace before ':'
    W503,  # line break before binary operator
    E501,  # line too long (handled by black)

exclude = 
    .git,
    __pycache__,
    .tox,
    .eggs,
    *.egg,
    build,
    dist,
    .venv,
    venv,
    env,
    ENV

[isort]
# isort configuration
profile = black
multi_line_output = 3
line_length = 100
known_first_party = app
known_third_party = pytest,fastapi,sqlalchemy,alembic,celery,redis,httpx

[mypy]
# mypy configuration
python_version = 3.11
warn_return_any = True
warn_unused_configs = True
disallow_untyped_defs = False  # Set to True when type hints are complete
ignore_missing_imports = True

[mypy-tests.*]
# Test modules configuration
disallow_untyped_defs = False

[coverage:run]
# Coverage configuration for tox
source = app
branch = True
parallel = True
omit = 
    */tests/*
    test_*.py
    conftest.py
    */migrations/*
    */celery_app.py

[coverage:report]
# Coverage report configuration
exclude_lines =
    pragma: no cover
    def __repr__
    if self.debug:
    if settings.DEBUG
    raise AssertionError
    raise NotImplementedError
    if 0:
    if __name__ == .__main__.:
    @abstractmethod

show_missing = True
precision = 2