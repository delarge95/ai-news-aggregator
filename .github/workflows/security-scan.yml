name: Security Scan

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main, develop ]
  schedule:
    # Run security scans daily at 2 AM UTC
    - cron: '0 2 * * *'
  workflow_dispatch:
    inputs:
      scan_type:
        description: 'Type of security scan to run'
        required: true
        default: 'full'
        type: choice
        options:
          - full
          - dependencies
          - container
          - code

env:
  REGISTRY: ghcr.io

jobs:
  # Job 1: Dependency Security Scan
  dependency-scan:
    name: ðŸ” Dependency Security Scan
    runs-on: ubuntu-latest
    steps:
      - name: ðŸ“¥ Checkout code
        uses: actions/checkout@v4

      - name: ðŸ Setup Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.11'

      - name: ðŸ“¦ Install Python dependencies
        run: |
          python -m pip install --upgrade pip
          pip install safety pip-audit

      - name: ðŸ” Install backend dependencies
        run: |
          pip install -r backend/requirements.txt

      - name: ðŸ” Run Safety check
        run: |
          cd backend
          safety check --json --output safety-report.json || true
          safety check --short-report

      - name: ðŸ” Run pip-audit
        run: |
          cd backend
          pip-audit --format=json --output=pip-audit-report.json || true
          pip-audit --desc

      - name: ðŸ“Š Upload dependency reports
        uses: actions/upload-artifact@v3
        with:
          name: dependency-scan-reports
          path: |
            backend/safety-report.json
            backend/pip-audit-report.json

  # Job 2: Container Security Scan
  container-scan:
    name: ðŸ³ Container Security Scan
    runs-on: ubuntu-latest
    steps:
      - name: ðŸ“¥ Checkout code
        uses: actions/checkout@v4

      - name: ðŸ” Build backend image
        run: |
          docker build -t security-scan-backend:latest ./backend

      - name: ðŸ” Build frontend image
        run: |
          docker build -t security-scan-frontend:latest ./frontend/ai-news-frontend

      - name: ðŸ” Scan backend image with Trivy
        uses: aquasecurity/trivy-action@master
        with:
          image-ref: 'security-scan-backend:latest'
          format: 'sarif'
          output: 'trivy-backend-results.sarif'

      - name: ðŸ” Scan frontend image with Trivy
        uses: aquasecurity/trivy-action@master
        with:
          image-ref: 'security-scan-frontend:latest'
          format: 'sarif'
          output: 'trivy-frontend-results.sarif'

      - name: ðŸ” Upload Trivy scan results to GitHub Security tab
        uses: github/codeql-action/upload-sarif@v2
        if: always()
        with:
          sarif_file: 'trivy-backend-results.sarif'

      - name: ðŸ” Upload Trivy scan results to GitHub Security tab
        uses: github/codeql-action/upload-sarif@v2
        if: always()
        with:
          sarif_file: 'trivy-frontend-results.sarif'

      - name: ðŸ” Run basic image security check
        run: |
          echo "ðŸ” Running basic container security checks..."
          
          # Check for known vulnerabilities in base images
          echo "Checking for outdated base images..."
          
          # Check for root user in containers
          echo "Checking for root user usage..."
          docker run --rm security-scan-backend:latest id || echo "Could not check user"
          
          # Check for sensitive files in images
          echo "Checking for sensitive files..."
          docker run --rm security-scan-backend:latest ls -la /etc/shadow /etc/passwd || echo "Sensitive files check completed"

      - name: ðŸ“ Upload container scan reports
        uses: actions/upload-artifact@v3
        with:
          name: container-scan-reports
          path: |
            trivy-backend-results.sarif
            trivy-frontend-results.sarif

  # Job 3: Code Security Scan
  code-scan:
    name: ðŸ›¡ï¸ Code Security Scan
    runs-on: ubuntu-latest
    steps:
      - name: ðŸ“¥ Checkout code
        uses: actions/checkout@v4

      - name: ðŸ Setup Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.11'

      - name: ðŸ“¦ Install security tools
        run: |
          pip install bandit semgrep

      - name: ðŸ” Run Bandit security linter
        run: |
          cd backend
          bandit -r . -f json -o bandit-report.json || true
          bandit -r . -ll

      - name: ðŸ” Run Semgrep
        run: |
          semgrep --config=auto --json --output=semgrep-report.json backend/ || true
          semgrep --config=auto backend/

      - name: ðŸ” CodeQL Analysis
        uses: github/codeql-action/init@v2
        with:
          languages: python, javascript

      - name: ðŸ“Š Autobuild
        uses: github/codeql-action/autobuild@v2

      - name: ðŸ” Perform CodeQL Analysis
        uses: github/codeql-action/analyze@v2

      - name: ðŸ“ Upload code scan reports
        uses: actions/upload-artifact@v3
        with:
          name: code-scan-reports
          path: |
            backend/bandit-report.json
            semgrep-report.json

  # Job 4: Infrastructure Security Scan
  infra-scan:
    name: ðŸ—ï¸ Infrastructure Security Scan
    runs-on: ubuntu-latest
    steps:
      - name: ðŸ“¥ Checkout code
        uses: actions/checkout@v4

      - name: ðŸ” Check Docker Compose configuration
        run: |
          echo "ðŸ” Analyzing Docker Compose configuration..."
          
          # Check for hardcoded secrets
          if grep -r "password\|secret\|key" docker-compose.yml | grep -v "^#" | grep -v "example"; then
            echo "âš ï¸  Warning: Potential hardcoded secrets found in docker-compose.yml"
          fi
          
          # Check for security configurations
          echo "ðŸ” Checking security configurations..."
          
          # Check for network configurations
          if grep -q "network" docker-compose.yml; then
            echo "âœ… Custom networks configured"
          else
            echo "âš ï¸  Using default networks - consider custom networks for isolation"
          fi
          
          # Check for resource limits
          if grep -q "cpus\|memory\|mem_limit" docker-compose.yml; then
            echo "âœ… Resource limits configured"
          else
            echo "âš ï¸  No resource limits found - consider adding limits"
          fi

      - name: ðŸ” Check Dockerfile security
        run: |
          echo "ðŸ” Analyzing Dockerfile security..."
          
          # Check for root user
          if ! grep -q "USER" backend/Dockerfile; then
            echo "âš ï¸  Warning: Running as root user in backend Dockerfile"
          else
            echo "âœ… Non-root user configured"
          fi
          
          # Check for latest tags
          if grep -q "FROM.*latest" backend/Dockerfile frontend/ai-news-frontend/Dockerfile; then
            echo "âš ï¸  Warning: Using 'latest' tags - consider pinned versions"
          else
            echo "âœ… Pinned base image versions"
          fi

      - name: ðŸ” Check GitHub Actions security
        run: |
          echo "ðŸ” Analyzing GitHub Actions configuration..."
          
          # Check for permissions
          if grep -q "permissions:" .github/workflows/*.yml; then
            echo "âœ… Explicit permissions configured"
          else
            echo "âš ï¸  No explicit permissions found - consider least privilege"
          fi
          
          # Check for secrets usage
          if grep -r "\${{ secrets\." .github/workflows/ > /dev/null; then
            echo "âœ… Using GitHub secrets for sensitive data"
          else
            echo "âš ï¸  No secrets usage detected - verify sensitive data handling"
          fi

  # Job 5: SAST (Static Application Security Testing)
  sast-scan:
    name: ðŸ” SAST Scan
    runs-on: ubuntu-latest
    steps:
      - name: ðŸ“¥ Checkout code
        uses: actions/checkout@v4

      - name: ðŸ” Initialize CodeQL
        uses: github/codeql-action/init@v2
        with:
          languages: python, javascript
          queries: security-extended,security-and-quality

      - name: ðŸ“Š Autobuild
        uses: github/codeql-action/autobuild@v2

      - name: ðŸ” Perform CodeQL Analysis
        uses: github/codeql-action/analyze@v2
        with:
          category: "/language:python,javascript"

  # Job 6: DAST (Dynamic Application Security Testing)
  dast-scan:
    name: ðŸŒ DAST Scan
    runs-on: ubuntu-latest
    if: github.event_name == 'schedule' || github.event.inputs.scan_type == 'full'
    steps:
      - name: ðŸ“¥ Checkout code
        uses: actions/checkout@v4

      - name: ðŸ³ Start application
        run: |
          docker-compose up -d postgres redis
          sleep 30

      - name: ðŸš€ Start backend for testing
        run: |
          cd backend
          python -m uvicorn app.main:app --host 0.0.0.0 --port 8000 &
        env:
          DATABASE_URL: postgresql+asyncpg://postgres:password@localhost:5432/ai_news_db
          REDIS_URL: redis://localhost:6379

      - name: ðŸ” Basic security headers check
        run: |
          echo "ðŸ” Checking security headers..."
          
          # Check for security headers
          response=$(curl -I http://localhost:8000/health 2>/dev/null)
          
          if echo "$response" | grep -i "x-frame-options" > /dev/null; then
            echo "âœ… X-Frame-Options header found"
          else
            echo "âš ï¸  X-Frame-Options header missing"
          fi
          
          if echo "$response" | grep -i "x-content-type-options" > /dev/null; then
            echo "âœ… X-Content-Type-Options header found"
          else
            echo "âš ï¸  X-Content-Type-Options header missing"
          fi
          
          if echo "$response" | grep -i "strict-transport-security" > /dev/null; then
            echo "âœ… HSTS header found"
          else
            echo "âš ï¸  HSTS header missing"
          fi

      - name: ðŸ§¹ Cleanup
        if: always()
        run: |
          docker-compose down -v

  # Job 7: Security Report Aggregation
  security-report:
    name: ðŸ“Š Security Report
    runs-on: ubuntu-latest
    needs: [dependency-scan, container-scan, code-scan, infra-scan, sast-scan]
    if: always()
    steps:
      - name: ðŸ“¥ Checkout code
        uses: actions/checkout@v4

      - name: ðŸ“¥ Download all artifacts
        uses: actions/download-artifact@v3

      - name: ðŸ“Š Generate security summary
        run: |
          echo "# ðŸ” Security Scan Report" > security-report.md
          echo "" >> security-report.md
          echo "**Repository:** ${{ github.repository }}" >> security-report.md
          echo "**Branch:** ${{ github.ref_name }}" >> security-report.md
          echo "**Commit:** ${{ github.sha }}" >> security-report.md
          echo "**Date:** $(date)" >> security-report.md
          echo "" >> security-report.md
          
          echo "## ðŸ“‹ Scan Results" >> security-report.md
          echo "" >> security-report.md
          
          # Dependency scan results
          if [ -f "dependency-scan-reports/safety-report.json" ]; then
            echo "### ðŸ” Dependency Security" >> security-report.md
            echo "- âœ… Dependency scan completed" >> security-report.md
          else
            echo "### ðŸ” Dependency Security" >> security-report.md
            echo "- âš ï¸  Dependency scan failed or not completed" >> security-report.md
          fi
          
          # Container scan results
          if [ -f "container-scan-reports/trivy-backend-results.sarif" ]; then
            echo "### ðŸ³ Container Security" >> security-report.md
            echo "- âœ… Container scan completed" >> security-report.md
          else
            echo "### ðŸ³ Container Security" >> security-report.md
            echo "- âš ï¸  Container scan failed or not completed" >> security-report.md
          fi
          
          # Code scan results
          if [ -f "code-scan-reports/bandit-report.json" ]; then
            echo "### ðŸ›¡ï¸ Code Security" >> security-report.md
            echo "- âœ… Code security scan completed" >> security-report.md
          else
            echo "### ðŸ›¡ï¸ Code Security" >> security-report.md
            echo "- âš ï¸  Code security scan failed or not completed" >> security-report.md
          fi
          
          echo "" >> security-report.md
          echo "## ðŸ“ Detailed Reports" >> security-report.md
          echo "All detailed security reports have been uploaded as artifacts." >> security-report.md
          echo "" >> security-report.md
          echo "## ðŸš¨ Action Required" >> security-report.md
          if [[ "${{ needs.dependency-scan.result }}" == "failure" || "${{ needs.container-scan.result }}" == "failure" || "${{ needs.code-scan.result }}" == "failure" ]]; then
            echo "- âŒ **CRITICAL**: Security vulnerabilities detected. Immediate action required!" >> security-report.md
          else
            echo "- âœ… No critical security issues detected" >> security-report.md
          fi
          
          cat security-report.md

      - name: ðŸ“¤ Upload security report
        uses: actions/upload-artifact@v3
        with:
          name: security-scan-report
          path: security-report.md

      - name: ðŸ“¤ Notify on critical issues
        if: failure()
        run: |
          echo "ðŸš¨ CRITICAL SECURITY ISSUES DETECTED!"
          echo "Repository: ${{ github.repository }}"
          echo "Branch: ${{ github.ref_name }}"
          echo "Please review the security reports immediately."