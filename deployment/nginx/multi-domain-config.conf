# Configuración para Múltiples Dominios - AI News Aggregator
# Soporte para dominios de producción, staging, desarrollo y subdominios dinámicos

# Variables para dominios
map $host $domain_type {
    default "production";
    
    # Producción
    ~^ainews\.production\.ai$ "production";
    ~^api\.ainews\.production\.ai$ "production_api";
    ~^cdn\.ainews\.production\.ai$ "production_cdn";
    ~^admin\.ainews\.production\.ai$ "production_admin";
    ~^docs\.ainews\.production\.ai$ "production_docs";
    
    # Staging
    ~^ainews\.staging\.ai$ "staging";
    ~^api\.ainews\.staging\.ai$ "staging_api";
    ~^cdn\.ainews\.staging\.ai$ "staging_cdn";
    ~^admin\.ainews\.staging\.ai$ "staging_admin";
    ~^docs\.ainews\.staging\.ai$ "staging_docs";
    
    # Desarrollo local
    ~^localhost$ "local";
    ~^127\.0\.0\.1$ "local";
    ~^dev\.ainews\.local$ "local_dev";
    ~^test\.ainews\.local$ "local_test";
    
    # Subdominios dinámicos
    ~^user[0-9]+\.ainews\.production\.ai$ "user_domain";
    ~^team[0-9]+\.ainews\.production\.ai$ "team_domain";
    ~^demo[0-9]+\.ainews\.production\.ai$ "demo_domain";
}

# Mapear dominio a backend correspondiente
map $domain_type $backend_service {
    default "frontend";
    
    # Producción
    production "frontend_prod";
    production_api "backend_prod";
    production_cdn "cdn_prod";
    production_admin "admin_prod";
    production_docs "docs_prod";
    
    # Staging
    staging "frontend_stage";
    staging_api "backend_stage";
    staging_cdn "cdn_stage";
    staging_admin "admin_stage";
    staging_docs "docs_stage";
    
    # Local
    local "frontend_local";
    local_dev "backend_local";
    local_test "frontend_test";
    
    # Dinámicos
    user_domain "backend_user";
    team_domain "backend_team";
    demo_domain "backend_demo";
}

# Configuración SSL por tipo de dominio
map $domain_type $ssl_cert {
    default "/etc/letsencrypt/live/ainews.production.ai/fullchain.pem";
    
    production "/etc/letsencrypt/live/ainews.production.ai/fullchain.pem";
    production_api "/etc/letsencrypt/live/ainews.production.ai/fullchain.pem";
    production_cdn "/etc/letsencrypt/live/ainews.production.ai/fullchain.pem";
    production_admin "/etc/letsencrypt/live/ainews.production.ai/fullchain.pem";
    production_docs "/etc/letsencrypt/live/ainews.production.ai/fullchain.pem";
    
    staging "/etc/letsencrypt/live/ainews.staging.ai/fullchain.pem";
    staging_api "/etc/letsencrypt/live/ainews.staging.ai/fullchain.pem";
    staging_cdn "/etc/letsencrypt/live/ainews.staging.ai/fullchain.pem";
    staging_admin "/etc/letsencrypt/live/ainews.staging.ai/fullchain.pem";
    staging_docs "/etc/letsencrypt/live/ainews.staging.ai/fullchain.pem";
    
    local "/etc/ssl/certs/ainews.local.pem";
    local_dev "/etc/ssl/certs/ainews.local.pem";
    local_test "/etc/ssl/certs/ainews.local.pem";
}

# Headers CSP específicos por dominio
map $domain_type $csp_header {
    default "default-src 'self'; script-src 'self' 'unsafe-inline'; style-src 'self' 'unsafe-inline'; img-src 'self' data: https:; connect-src 'self';";
    
    production "default-src 'self'; script-src 'self' 'unsafe-inline' https://cdn.jsdelivr.net; style-src 'self' 'unsafe-inline' https://fonts.googleapis.com; img-src 'self' data: https:; connect-src 'self' https://api.ainews.production.ai; font-src 'self' https://fonts.gstatic.com;";
    
    staging "default-src 'self'; script-src 'self' 'unsafe-inline' 'unsafe-eval'; style-src 'self' 'unsafe-inline'; img-src 'self' data: https:; connect-src 'self';";
    
    local "default-src 'self' 'unsafe-inline'; script-src 'self' 'unsafe-inline' 'unsafe-eval'; style-src 'self' 'unsafe-inline';";
    
    production_admin "default-src 'self'; script-src 'self'; style-src 'self' 'unsafe-inline'; img-src 'self' data:; connect-src 'self' https://api.ainews.production.ai;";
}

# Rate limiting específico por tipo de dominio
map $domain_type $rate_limit_zone {
    default "general";
    
    production_api "api_strict";
    production_admin "admin_strict";
    staging_api "api_strict";
    local_dev "development";
    user_domain "user_limit";
}

# Server principal para producción
server {
    listen 443 ssl http2;
    listen [::]:443 ssl http2;
    server_name ainews.production.ai;
    
    include /etc/nginx/ssl-common.conf;
    ssl_certificate $ssl_cert;
    ssl_certificate_key /etc/letsencrypt/live/ainews.production.ai/privkey.pem;
    
    # Headers específicos para producción
    add_header X-Environment "production";
    add_header X-Version "v1.0.0";
    add_header Content-Security-Policy $csp_header always;
    
    include /etc/nginx/locations-common.conf;
    include /etc/nginx/multi-domain-upstreams.conf;
}

# Server para API de producción
server {
    listen 443 ssl http2;
    listen [::]:443 ssl http2;
    server_name api.ainews.production.ai;
    
    include /etc/nginx/ssl-common.conf;
    ssl_certificate $ssl_cert;
    
    add_header X-Environment "production";
    add_header X-Service "api";
    add_header Content-Security-Policy "default-src 'self'; connect-src 'self' wss:; script-src 'self'; style-src 'self';" always;
    
    # Solo proxy a backend API
    location / {
        proxy_pass http://backend_prod;
        include /etc/nginx/api-proxy.conf;
    }
}

# Server para CDN de producción
server {
    listen 443 ssl http2;
    listen [::]:443 ssl http2;
    server_name cdn.ainews.production.ai;
    
    include /etc/nginx/ssl-common.conf;
    ssl_certificate $ssl_cert;
    
    add_header X-Environment "production";
    add_header X-Service "cdn";
    add_header Cache-Control "public, max-age=86400" always;
    
    # Cache agresivo para CDN
    location ~* \.(css|js|png|jpg|jpeg|gif|svg|ico|woff|woff2|ttf|eot)$ {
        expires 30d;
        add_header Cache-Control "public, max-age=2592000, immutable";
        add_header Vary "Accept-Encoding";
        
        # Verificar si existe en local, sino buscar en upstream
        try_files $uri @cdn_backend;
    }
    
    location @cdn_backend {
        proxy_pass http://cdn_prod;
        include /etc/nginx/cdn-proxy.conf;
    }
}

# Server para administración de producción
server {
    listen 443 ssl http2;
    listen [::]:443 ssl http2;
    server_name admin.ainews.production.ai;
    
    include /etc/nginx/ssl-common.conf;
    ssl_certificate $ssl_cert;
    
    add_header X-Environment "production";
    add_header X-Service "admin";
    add_header Content-Security-Policy "default-src 'self'; script-src 'self'; style-src 'self' 'unsafe-inline'; img-src 'self' data:; connect-src 'self' https://api.ainews.production.ai;" always;
    
    # Autenticación básica para admin
    auth_basic "Admin Area";
    auth_basic_user_file /etc/nginx/.htpasswd;
    
    # Rate limiting muy estricto para admin
    limit_req zone=admin_strict burst=3 nodelay;
    limit_conn addr 10;
    
    location / {
        proxy_pass http://admin_prod;
        include /etc/nginx/admin-proxy.conf;
    }
}

# Server para staging
server {
    listen 443 ssl http2;
    listen [::]:443 ssl http2;
    server_name ainews.staging.ai;
    
    include /etc/nginx/ssl-common.conf;
    ssl_certificate $ssl_cert;
    
    add_header X-Environment "staging";
    add_header X-Version "dev";
    add_header Content-Security-Policy $csp_header always;
    
    # Headers que indican que es staging
    add_header X-Staging "true";
    
    include /etc/nginx/locations-common.conf;
    include /etc/nginx/multi-domain-upstreams.conf;
}

# Server para API de staging
server {
    listen 443 ssl http2;
    listen [::]:443 ssl http2;
    server_name api.ainews.staging.ai;
    
    include /etc/nginx/ssl-common.conf;
    ssl_certificate $ssl_cert;
    
    add_header X-Environment "staging";
    add_header X-Service "api";
    add_header Content-Security-Policy "default-src 'self'; connect-src 'self' wss:; script-src 'self' 'unsafe-eval'; style-src 'self';" always;
    
    location / {
        proxy_pass http://backend_stage;
        include /etc/nginx/api-proxy.conf;
    }
}

# Server para desarrollo local
server {
    listen 443 ssl http2;
    listen [::]:443 ssl http2;
    server_name ainews.local;
    
    ssl_certificate /etc/ssl/certs/ainews.local.pem;
    ssl_certificate_key /etc/ssl/private/ainews.local.key;
    
    # Configuraciones más permisivas para desarrollo
    add_header X-Environment "local";
    add_header X-Debug "true";
    add_header Content-Security-Policy "default-src 'self' 'unsafe-inline' 'unsafe-eval'; script-src 'self' 'unsafe-inline' 'unsafe-eval'; style-src 'self' 'unsafe-inline'; img-src 'self' data:; connect-src 'self' ws: wss:;" always;
    
    # Sin rate limiting estricto para desarrollo
    limit_req zone=development burst=100 nodelay;
    
    location / {
        proxy_pass http://frontend_local;
        include /etc/nginx/local-proxy.conf;
    }
    
    location /api/ {
        proxy_pass http://backend_local;
        include /etc/nginx/api-proxy.conf;
    }
}

# Server para subdominios dinámicos de usuarios
server {
    listen 443 ssl http2;
    listen [::]:443 ssl http2;
    server_name ~^(user[0-9]+)\.ainews\.production\.ai$;
    
    include /etc/nginx/ssl-common.conf;
    ssl_certificate $ssl_cert;
    
    add_header X-Environment "production";
    add_header X-Service "user-tenant";
    add_header Content-Security-Policy "default-src 'self'; script-src 'self'; style-src 'self' 'unsafe-inline'; img-src 'self' data:; connect-src 'self' https://api.ainews.production.ai;" always;
    
    # Extraer nombre de usuario del subdominio
    set $username $1;
    
    # Rate limiting específico por usuario
    limit_req zone=user_limit burst=50 nodelay;
    
    location / {
        # Proxy específico para el usuario
        proxy_pass http://backend_user;
        include /etc/nginx/tenant-proxy.conf;
        
        # Headers específicos de tenant
        proxy_set_header X-Tenant-Type "user";
        proxy_set_header X-Username $username;
    }
}

# Server para subdominios de equipos
server {
    listen 443 ssl http2;
    listen [::]:443 ssl http2;
    server_name ~^(team[0-9]+)\.ainews\.production\.ai$;
    
    include /etc/nginx/ssl-common.conf;
    ssl_certificate $ssl_cert;
    
    add_header X-Environment "production";
    add_header X-Service "team-tenant";
    add_header Content-Security-Policy "default-src 'self'; script-src 'self'; style-src 'self' 'unsafe-inline'; img-src 'self' data:; connect-src 'self' https://api.ainews.production.ai;" always;
    
    set $team_id $1;
    
    # Rate limiting específico por equipo
    limit_req zone=team_limit burst=30 nodelay;
    
    location / {
        proxy_pass http://backend_team;
        include /etc/nginx/tenant-proxy.conf;
        
        proxy_set_header X-Tenant-Type "team";
        proxy_set_header X-TeamID $team_id;
    }
}

# Server para dominios de demostración
server {
    listen 443 ssl http2;
    listen [::]:443 ssl http2;
    server_name ~^(demo[0-9]+)\.ainews\.production\.ai$;
    
    include /etc/nginx/ssl-common.conf;
    ssl_certificate $ssl_cert;
    
    add_header X-Environment "production";
    add_header X-Service "demo";
    add_header X-Demo "true";
    
    # Rate limiting muy permisivo para demos
    limit_req zone=development burst=200 nodelay;
    
    location / {
        proxy_pass http://backend_demo;
        include /etc/nginx/demo-proxy.conf;
        
        proxy_set_header X-Tenant-Type "demo";
        proxy_set_header X-Demo-Mode "true";
    }
}

# Configuración común para redirecciones HTTP a HTTPS
server {
    listen 80;
    listen [::]:80;
    server_name ainews.production.ai ainews.staging.ai *.ainews.production.ai *.ainews.staging.ai ainews.local;
    
    # Let's Encrypt challenge
    location /.well-known/acme-challenge/ {
        root /var/www/certbot;
        allow all;
    }
    
    # Redirección a HTTPS
    location / {
        return 301 https://$host$request_uri;
    }
}