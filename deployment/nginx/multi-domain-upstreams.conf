# Configuración de Upstreams para Múltiples Dominios
# AI News Aggregator - Load Balancing y Servidores Backend

# Upstreams para producción
upstream frontend_prod {
    least_conn;
    server 10.0.1.201:3000 weight=3 max_fails=3 fail_timeout=30s;
    server 10.0.1.202:3000 weight=3 max_fails=3 fail_timeout=30s;
    server 10.0.1.203:3000 weight=2 max_fails=3 fail_timeout=30s;
    keepalive 32;
}

upstream backend_prod {
    ip_hash;
    server 10.0.1.101:8000 weight=5 max_fails=2 fail_timeout=10s;
    server 10.0.1.102:8000 weight=5 max_fails=2 fail_timeout=10s;
    server 10.0.1.103:8000 weight=3 max_fails=3 fail_timeout=30s;
    server 10.0.1.104:8000 weight=2 max_fails=3 fail_timeout=30s backup;
    keepalive 64;
}

upstream cdn_prod {
    round_robin;
    server 10.0.1.251:8080 weight=1 max_fails=1 fail_timeout=5s;
    server 10.0.1.252:8080 weight=1 max_fails=1 fail_timeout=5s;
    keepalive 16;
}

upstream admin_prod {
    round_robin;
    server 10.0.1.301:3001 weight=1 max_fails=2 fail_timeout=30s;
    server 10.0.1.302:3001 weight=1 max_fails=2 fail_timeout=30s backup;
    keepalive 8;
}

upstream docs_prod {
    round_robin;
    server 10.0.1.351:4000 weight=1 max_fails=2 fail_timeout=30s;
    keepalive 8;
}

# Upstreams para staging
upstream frontend_stage {
    round_robin;
    server 10.0.2.201:3000 weight=2 max_fails=3 fail_timeout=30s;
    server 10.0.2.202:3000 weight=1 max_fails=3 fail_timeout=30s;
    keepalive 16;
}

upstream backend_stage {
    round_robin;
    server 10.0.2.101:8000 weight=2 max_fails=3 fail_timeout=30s;
    server 10.0.2.102:8000 weight=1 max_fails=3 fail_timeout=30s backup;
    keepalive 32;
}

upstream cdn_stage {
    round_robin;
    server 10.0.2.251:8080 weight=1 max_fails=2 fail_timeout=30s;
    keepalive 8;
}

upstream admin_stage {
    round_robin;
    server 10.0.2.301:3001 weight=1 max_fails=3 fail_timeout=30s;
    keepalive 4;
}

upstream docs_stage {
    round_robin;
    server 10.0.2.351:4000 weight=1 max_fails=3 fail_timeout=30s;
    keepalive 4;
}

# Upstreams para desarrollo local
upstream frontend_local {
    server 127.0.0.1:3000 weight=1 max_fails=1 fail_timeout=5s;
    keepalive 8;
}

upstream backend_local {
    server 127.0.0.1:8000 weight=1 max_fails=1 fail_timeout=5s;
    keepalive 16;
}

upstream frontend_test {
    server 127.0.0.1:3001 weight=1 max_fails=1 fail_timeout=5s;
    keepalive 4;
}

# Upstreams para subdominios dinámicos (usuarios)
upstream backend_user {
    # Selector basado en hash de usuario para sticky sessions
    hash $username consistent;
    server 10.0.3.101:8000 weight=3 max_fails=2 fail_timeout=10s;
    server 10.0.3.102:8000 weight=3 max_fails=2 fail_timeout=10s;
    server 10.0.3.103:8000 weight=2 max_fails=3 fail_timeout=30s;
    keepalive 32;
}

# Upstreams para subdominios de equipos
upstream backend_team {
    # Algoritmo de balance para equipos (más balanceado)
    least_conn;
    server 10.0.4.101:8000 weight=4 max_fails=2 fail_timeout=15s;
    server 10.0.4.102:8000 weight=3 max_fails=2 fail_timeout=15s;
    server 10.0.4.103:8000 weight=2 max_fails=3 fail_timeout=30s;
    keepalive 32;
}

# Upstreams para demostraciones
upstream backend_demo {
    # Configuración especial para demos (alta disponibilidad)
    round_robin;
    server 10.0.5.101:8000 weight=2 max_fails=1 fail_timeout=5s;
    server 10.0.5.102:8000 weight=2 max_fails=1 fail_timeout=5s;
    server 10.0.5.103:8000 weight=1 max_fails=2 fail_timeout=10s backup;
    keepalive 64;
}

# Configuraciones de health check por ambiente
# Health check para producción
map $upstream_name $health_check {
    default "/health";
    
    backend_prod "/api/health";
    backend_stage "/api/health";
    backend_local "/health";
    backend_user "/api/v1/health";
    backend_team "/api/v1/health";
    backend_demo "/health";
}

# Configuraciones de timeout específicas
map $upstream_name $backend_timeout {
    default "60s";
    
    frontend_prod "30s";
    frontend_stage "30s";
    frontend_local "15s";
    
    backend_prod "120s";
    backend_stage "60s";
    backend_local "30s";
    backend_user "90s";
    backend_team "90s";
    backend_demo "60s";
    
    cdn_prod "15s";
    cdn_stage "15s";
    
    admin_prod "45s";
    admin_stage "30s";
    
    docs_prod "30s";
    docs_stage "30s";
}

# Configuraciones de retry por tipo de servicio
map $upstream_name $retry_policy {
    default "1";
    
    frontend_prod "2";
    backend_prod "3";
    backend_stage "2";
    backend_user "2";
    backend_team "2";
    backend_demo "1";
    
    admin_prod "1";
    admin_stage "1";
    
    cdn_prod "1";
    cdn_stage "1";
    
    docs_prod "2";
    docs_stage "2";
}

# Configuraciones de peso dinámico basado en carga
# (Esto se puede actualizar via API de gestión)
upstream dynamic_prod_backend {
    least_conn;
    
    # Configuración base que puede ser modificada dinámicamente
    server 10.0.1.101:8000 weight=5 max_fails=2 fail_timeout=10s;
    server 10.0.1.102:8000 weight=5 max_fails=2 fail_timeout=10s;
    server 10.0.1.103:8000 weight=3 max_fails=3 fail_timeout=30s;
    
    # Servidor de monitoreo (solo para health check)
    server 127.0.0.1:9999 weight=1 max_fails=1 fail_timeout=1s backup;
    
    keepalive 64;
}

# Configuración de circuit breaker
upstream circuit_breaker_backend {
    # Backend con protección de circuit breaker
    server 10.0.1.101:8000 weight=3 max_fails=2 fail_timeout=10s;
    server 10.0.1.102:8000 weight=3 max_fails=2 fail_timeout=10s;
    
    # Si todos los backends fallan, usar servidor de respaldo
    server 127.0.0.1:8888 weight=1 max_fails=1 fail_timeout=60s backup;
    
    keepalive 32;
}

# Configuración para graceful shutdown
upstream graceful_backend {
    # Backend que maneja graceful shutdown
    server 10.0.1.101:8000 weight=3 max_fails=1 fail_timeout=5s;
    server 10.0.1.102:8000 weight=3 max_fails=1 fail_timeout=5s;
    
    # Si un servidor está en mantenimiento, usar solo los demás
    server 10.0.1.103:8000 weight=1 max_fails=1 fail_timeout=5s down;
    
    keepalive 32;
}

# Configuraciones de seguridad específicas
# Rate limiting por upstream
limit_req_zone $binary_remote_addr zone=production_api:10m rate=100r/s;
limit_req_zone $binary_remote_addr zone=staging_api:10m rate=50r/s;
limit_req_zone $binary_remote_addr zone=user_tenants:10m rate=20r/s;
limit_req_zone $binary_remote_addr zone=admin_area:10m rate=10r/m;

# Connection limiting por upstream
limit_conn_zone $binary_remote_addr zone=production_conn:10m;
limit_conn_zone $binary_remote_addr zone=staging_conn:10m;
limit_conn_zone $binary_remote_addr zone=cdn_conn:10m;

# Configuraciones de logging específicas
# Logs por tipo de servicio
access_log /var/log/nginx/frontend-prod.log combined if=$domain_type=production;
access_log /var/log/nginx/backend-prod.log combined if=$domain_type=production_api;
access_log /var/log/nginx/cdn-prod.log combined if=$domain_type=production_cdn;
access_log /var/log/nginx/admin-prod.log combined if=$domain_type=production_admin;

# Configuraciones de compresión específicas
# Compresión agresiva para CDN
map $upstream_name $compression_level {
    default "6";
    
    cdn_prod "9";
    cdn_stage "7";
    frontend_prod "6";
    backend_prod "4";
    admin_prod "5";
    docs_prod "6";
}

# Configuraciones de cache específicas
# Cache headers por servicio
map $upstream_name $cache_headers {
    default "Cache-Control: public, max-age=3600";
    
    frontend_prod "Cache-Control: public, max-age=1800, s-maxage=3600";
    frontend_stage "Cache-Control: public, max-age=600, s-maxage=1800";
    cdn_prod "Cache-Control: public, max-age=86400, s-maxage=604800";
    cdn_stage "Cache-Control: public, max-age=3600, s-maxage=21600";
    admin_prod "Cache-Control: private, max-age=0, no-cache, no-store";
    docs_prod "Cache-Control: public, max-age=7200, s-maxage=14400";
}

# Configuraciones de SSL específicas por servicio
# SSL session caching
map $upstream_name $ssl_session_cache {
    default "shared:SSL:10m";
    
    backend_prod "shared:SSL:50m";
    backend_stage "shared:SSL:25m";
    cdn_prod "shared:SSL:10m";
    frontend_prod "shared:SSL:25m";
}