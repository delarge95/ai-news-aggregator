# Configuración HAProxy para AI News Aggregator
# Load Balancer con múltiples algoritmos y health checks

# Configuraciones globales
global
    log stdout local0
    log stdout local1 notice
    chroot /var/lib/haproxy
    stats socket /run/haproxy/admin.sock mode 660 level admin
    stats timeout 30s
    user haproxy
    group haproxy
    daemon
    
    # Configuraciones de seguridad
    ssl-default-bind-ciphers ECDHE-ECDSA-AES128-GCM-SHA256:ECDHE-RSA-AES128-GCM-SHA256:ECDHE-ECDSA-AES256-GCM-SHA384:ECDHE-RSA-AES256-GCM-SHA384:ECDHE-ECDSA-CHACHA20-POLY1305:ECDHE-RSA-CHACHA20-POLY1305:DHE-RSA-AES128-GCM-SHA256:DHE-RSA-AES256-GCM-SHA384
    ssl-default-bind-options ssl-min-ver TLSv1.2 no-tls-tickets
    ssl-default-server-ciphers ECDHE-ECDSA-AES128-GCM-SHA256:ECDHE-RSA-AES128-GCM-SHA256:ECDHE-ECDSA-AES256-GCM-SHA384:ECDHE-RSA-AES256-GCM-SHA384:ECDHE-ECDSA-CHACHA20-POLY1305:ECDHE-RSA-CHACHA20-POLY1305:DHE-RSA-AES128-GCM-SHA256:DHE-RSA-AES256-GCM-SHA384
    ssl-default-server-options ssl-min-ver TLSv1.2 no-tls-tickets
    
    # Tuning de rendimiento
    tune.ssl.default-dh-param 2048
    tune.maxrewrite 1024
    tune.bufsize 32768
    tune.maxaccept 8
    
    # Timeouts
    timeout connect 5s
    timeout client 1m
    timeout server 1m
    timeout tunnel 3600s
    timeout http-request 30s
    timeout http-keep-alive 30s

# Configuraciones por defecto
defaults
    mode http
    log global
    option httplog
    option dontlognull
    option redispatch
    retries 3
    timeout connect 10s
    timeout client 50s
    timeout server 50s
    
    # Health checks
    option httpchk GET /health
    http-check expect status 200
    
    # Compression
    compression algo gzip
    compression type text/html text/plain text/css application/json application/javascript text/xml application/xml application/xml+rss text/javascript application/vnd.ms-fontobject application/vnd.ms-excel application/vnd.ms-powerpoint application/atom+xml application/geo+json application/javascript application/x-javascript application/json application/ld+json application/manifest+json application/rdf+xml application/rss+xml application/x-font-ttf application/x-opentype image/svg+xml image/x-icon text/css text/plain text/x-component
    
    # Error pages personalizadas
    errorfile 400 /etc/haproxy/errors/400.http
    errorfile 403 /etc/haproxy/errors/403.http
    errorfile 408 /etc/haproxy/errors/408.http
    errorfile 500 /etc/haproxy/errors/500.http
    errorfile 502 /etc/haproxy/errors/502.http
    errorfile 503 /etc/haproxy/errors/503.http
    errorfile 504 /etc/haproxy/errors/504.http

# Stats page
frontend stats
    bind *:8404
    stats enable
    stats uri /stats
    stats refresh 30s
    stats show-node
    stats show-legends
    stats auth admin:secure_password_here
    
    # Permitir acceso solo desde red interna
    acl internal_net src 192.168.1.0/24 10.0.0.0/8 172.16.0.0/12
    tcp-request connection reject if !internal_net

# Frontend principal para HTTPS
frontend https_frontend
    bind *:443 ssl crt /etc/ssl/certs/ainews.production.ai.pem alpn h2,http/1.1
    bind *:443 ssl crt /etc/ssl/certs/ainews.staging.ai.pem alpn h2,http/1.1
    
    # Security headers
    http-response set-header Strict-Transport-Security "max-age=31536000; includeSubDomains; preload" if { ssl_fc }
    http-response set-header X-Frame-Options "SAMEORIGIN" always
    http-response set-header X-Content-Type-Options "nosniff" always
    http-response set-header X-XSS-Protection "1; mode=block" always
    http-response set-header Referrer-Policy "strict-origin-when-cross-origin" always
    
    # Redirección HTTPS
    redirect scheme https if !{ ssl_fc }
    
    # Rate limiting por IP
    stick-table type ip size 100k expire 30s store conn_cur,conn_rate(10s),http_req_rate(10s)
    tcp-request connection track-sc1 src
    tcp-request connection accept if { src_conn_cur lt 100 }
    tcp-request connection reject if { src_conn_rate gt 20 }
    
    # Routing por tipo de contenido
    use_backend backend_api if { path_beg /api/ }
    use_backend backend_websocket if { path_beg /ws/ }
    use_backend frontend_app if { path_beg / }
    
    # Bloqueo de IPs sospechosas
    http-request deny if { src -f /etc/haproxy/blocklist.txt }

# Frontend para HTTP (redirección a HTTPS)
frontend http_frontend
    bind *:80
    
    # Let's Encrypt challenge
    acl letsencrypt path_beg /.well-known/acme-challenge/
    use_backend letsencrypt_backend if letsencrypt
    
    # Redirección a HTTPS
    redirect scheme https if !{ ssl_fc }
    
    # Para otros casos, usar backend principal
    default_backend frontend_app

# Backend para API
backend backend_api
    balance roundrobin
    
    # Configuración de sesiones
    option httpchk GET /health
    http-check expect status 200
    
    # Timeouts específicos para API
    timeout server 60s
    timeout connect 10s
    
    # Servidores backend
    server api1 10.0.1.101:8000 check inter 10s rise 2 fall 3
    server api2 10.0.1.102:8000 check inter 10s rise 2 fall 3
    server api3 10.0.1.103:8000 check inter 10s rise 2 fall 3
    
    # Cookie para sticky sessions
    cookie AINEWS_API insert indirect nocache
    server api1 10.0.1.101:8000 check inter 10s rise 2 fall 3 cookie api1
    server api2 10.0.1.102:8000 check inter 10s rise 2 fall 3 cookie api2
    server api3 10.0.1.103:8000 check inter 10s rise 2 fall 3 cookie api3

# Backend para WebSocket
backend backend_websocket
    balance source
    
    # Verificación específica para WebSocket
    option httpchk GET /ws/health
    http-check expect status 200
    
    # Servidores WebSocket
    server ws1 10.0.1.101:8001 check inter 5s rise 2 fall 3
    server ws2 10.0.1.102:8001 check inter 5s rise 2 fall 3
    
    # Sticky sessions importantes para WebSocket
    stick-table type ip size 50k expire 300s store conn_cur
    stick on src

# Backend para Frontend
backend frontend_app
    balance roundrobin
    
    # Cache headers para contenido estático
    http-response set-header Cache-Control "public, max-age=3600" if { path_end .css .js .png .jpg .jpeg .gif .ico .svg }
    http-response set-header Cache-Control "public, max-age=86400" if { path_end .woff .woff2 .ttf }
    
    # Servidores frontend
    server fe1 10.0.1.201:3000 check inter 10s rise 2 fall 3
    server fe2 10.0.1.202:3000 check inter 10s rise 2 fall 3
    server fe3 10.0.1.203:3000 check inter 10s rise 2 fall 3
    
    # Cookie para sticky sessions
    cookie AINEWS_FE insert indirect nocache

# Backend para Let's Encrypt challenges
backend letsencrypt_backend
    mode http
    balance roundrobin
    server certbot1 127.0.0.1:8080 check
    server certbot2 127.0.0.1:8081 check

# Configuraciones específicas por dominio
# Dominio de producción
frontend production_https
    bind *:443 ssl crt /etc/ssl/certs/ainews.production.ai.pem alpn h2,http/1.1
    
    # Headers específicos para producción
    http-response set-header X-Environment "production"
    http-response set-header Content-Security-Policy "default-src 'self'; script-src 'self' 'unsafe-inline' 'unsafe-eval'; style-src 'self' 'unsafe-inline'; img-src 'self' data: https:; connect-src 'self' https://api.ainews.production.ai wss:;"
    
    default_backend backend_api

# Dominio de staging
frontend staging_https
    bind *:444 ssl crt /etc/ssl/certs/ainews.staging.ai.pem alpn h2,http/1.1
    
    # Headers específicos para staging
    http-response set-header X-Environment "staging"
    http-response set-header Content-Security-Policy "default-src 'self'; script-src 'self' 'unsafe-inline' 'unsafe-eval'; style-src 'self' 'unsafe-inline';"
    
    default_backend backend_api_staging

# Backend específico para staging
backend backend_api_staging
    balance roundrobin
    server api1-stage 10.0.1.111:8000 check inter 10s rise 2 fall 3
    server api2-stage 10.0.1.112:8000 check inter 10s rise 2 fall 3

# Configuración de health checks mejorados
# Health check para API
backend health_api
    option httpchk GET /api/health
    
    http-check expect status 200
    
    # Agregar headers personalizados
    http-check send hdr X-Check "HAProxy-Health-Check"
    
    server api-health1 10.0.1.101:8000 check inter 5s rise 3 fall 2
    server api-health2 10.0.1.102:8000 check inter 5s rise 3 fall 2
    server api-health3 10.0.1.103:8000 check inter 5s rise 3 fall 2

# Configuración de timeout por tipo de contenido
# API con timeouts más largos
frontend api_timeouts
    default_backend backend_api
    timeout server 120s
    timeout client 120s
    
# Frontend con timeouts más cortos
frontend frontend_timeouts
    default_backend frontend_app
    timeout server 60s
    timeout client 60s

# Configuración de compression por backend
backend compress_backend
    compression algo gzip
    compression type text/html text/plain text/css application/json application/javascript text/xml application/xml application/xml+rss text/javascript
    
    # Compression level
    compression offload

# Configuración de logging detallada
# Logs de access
capture request header Host len 64
capture request header User-Agent len 128
capture request header Referer len 128
capture response header Content-Type len 32
capture response header Content-Length len 10

# Logs específicos para API
frontend api_logs
    capture request header Authorization len 32
    capture request header X-Request-ID len 32
    capture request header X-API-Key len 32

# Configuración de circuit breaker
# Configuración básica para el backend principal
backend circuit_breaker
    balance roundrobin
    
    # Circuit breaker settings
    http-response set-header X-Circuit-Breaker "enabled"
    
    # Threshold para circuit breaker
    option httpchk GET /api/health
    http-check expect status 200
    
    # Configurar reintentos con backoff
    retries 3
    option redispatch
    retry-on all-retryable-errors
    
    server api1-cb 10.0.1.101:8000 check inter 5s rise 2 fall 3
    server api2-cb 10.0.1.102:8000 check inter 5s rise 2 fall 3
    server api3-cb 10.0.1.103:8000 check inter 5s rise 2 fall 3

# Configuración de modo mantenimiento
backend maintenance_backend
    mode http
    errorfile 503 /etc/haproxy/errors/503-maintenance.http
    
    # Servidor único para modo mantenimiento
    server maintenance 127.0.0.1:9999 check

# Variables de configuración
# Configuración de rates por IP
frontend rate_limiting
    stick-table type ip size 100k expire 60s store http_req_rate(1m),conn_cur
    tcp-request connection track-sc1 src
    tcp-request connection reject if { src_http_req_rate gt 100 }
    
    default_backend backend_api