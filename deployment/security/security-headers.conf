# Configuración de Headers de Seguridad para AI News Aggregator
# Headers HTTP de seguridad para proteger contra ataques comunes

# Content Security Policy (CSP)
# Controla qué recursos puede cargar la página
add_header Content-Security-Policy "default-src 'self'; \
    script-src 'self' 'unsafe-inline' 'unsafe-eval' https://cdn.jsdelivr.net https://unpkg.com https://www.googletagmanager.com https://www.google-analytics.com; \
    style-src 'self' 'unsafe-inline' https://fonts.googleapis.com https://cdn.jsdelivr.net; \
    font-src 'self' https://fonts.gstatic.com https://cdn.jsdelivr.net; \
    img-src 'self' data: https: blob:; \
    connect-src 'self' https://api.ainews.production.ai https://api.ainews.staging.ai wss:; \
    media-src 'self' data: blob:; \
    object-src 'none'; \
    child-src 'self' https://www.youtube.com https://player.vimeo.com; \
    worker-src 'self'; \
    frame-ancestors 'self' https://www.youtube.com https://player.vimeo.com; \
    form-action 'self'; \
    base-uri 'self'; \
    manifest-src 'self'; \
    upgrade-insecure-requests; \
    block-all-mixed-content" always;

# Strict Transport Security (HSTS)
# Fuerza el uso de HTTPS
add_header Strict-Transport-Security "max-age=31536000; includeSubDomains; preload" always;

# X-Frame-Options
# Previene clickjacking
add_header X-Frame-Options "SAMEORIGIN" always;

# X-Content-Type-Options
# Previene MIME sniffing
add_header X-Content-Type-Options "nosniff" always;

# X-XSS-Protection
# Protección básica contra XSS (legacy, pero mantenido para navegadores antiguos)
add_header X-XSS-Protection "1; mode=block" always;

# Referrer Policy
# Controla información de referrer enviada
add_header Referrer-Policy "strict-origin-when-cross-origin" always;

# Permissions Policy (antes Feature Policy)
# Controla acceso a características del navegador
add_header Permissions-Policy "geolocation=(), \
    microphone=(), \
    camera=(), \
    payment=(), \
    usb=(), \
    magnetometer=(), \
    gyroscope=(), \
    speaker=(), \
    vibrate=(), \
    fullscreen=(), \
    picture-in-picture=(), \
    screen-wake-lock=(), \
    web-share=(), \
    xr-spatial-tracking=()" always;

# Feature Policy (legacy)
add_header Feature-Policy "geolocation 'none'; \
    microphone 'none'; \
    camera 'none'; \
    payment 'none'; \
    usb 'none'; \
    magnetometer 'none'; \
    gyroscope 'none'; \
    speaker 'none'; \
    vibrate 'none'; \
    fullscreen 'self'; \
    picture-in-picture 'self'" always;

# Cross-Origin Resource Policy (CORP)
# Controla acceso cross-origin a recursos
add_header Cross-Origin-Resource-Policy "same-origin" always;

# Cross-Origin Embedder Policy (COEP)
# Mejora seguridad en recursos embebidos
add_header Cross-Origin-Embedder-Policy "require-corp" always;

# Cross-Origin Opener Policy (COOP)
# Mejora seguridad en ventanas relacionadas
add_header Cross-Origin-Opener-Policy "same-origin" always;

# Cache-Control para páginas dinámicas
# Previene cacheado de contenido sensible
location ~* ^/(admin|login|auth|dashboard|profile) {
    add_header Cache-Control "no-cache, no-store, must-revalidate, private";
    add_header Pragma "no-cache";
    add_header Expires "0";
}

# Cache-Control para páginas públicas
# Permite cacheado de contenido público
location ~* ^/(about|contact|terms|privacy|api/docs) {
    add_header Cache-Control "public, max-age=3600, must-revalidate";
}

# Cache-Control para archivos estáticos
# Cacheado agresivo de recursos estáticos
location ~* \.(css|js|png|jpg|jpeg|gif|ico|svg|woff|woff2|ttf|eot)$ {
    add_header Cache-Control "public, max-age=31536000, immutable";
    add_header Vary "Accept-Encoding";
}

# Headers adicionales de seguridad
# OCSP Stapling (requiere configuración SSL)
# ssl_stapling on;
# ssl_stapling_verify on;

# Additional Security Headers
# Server signature
server_tokens off;

# Hide version information
proxy_hide_header X-Powered-By;

# Rate limiting headers
add_header X-RateLimit-Limit "50";
add_header X-RateLimit-Remaining "49";
add_header X-RateLimit-Reset "60";

# CORS headers para API
location /api/ {
    add_header Access-Control-Allow-Origin "https://ainews.production.ai" always;
    add_header Access-Control-Allow-Methods "GET, POST, PUT, DELETE, OPTIONS" always;
    add_header Access-Control-Allow-Headers "Content-Type, Authorization, X-Requested-With" always;
    add_header Access-Control-Max-Age "86400" always;
}

# Prevenir acceso a archivos sensibles
location ~ /\. {
    deny all;
    access_log off;
    log_not_found off;
}

location ~ \.(sql|db|conf|log|env|bak|backup)$ {
    deny all;
    access_log off;
    log_not_found off;
}

# Headers específicos para API responses
location /api/ {
    add_header API-Version "v1" always;
    add_header API-Security-Level "high" always;
}

# Security headers para WebSocket connections
location /ws/ {
    add_header WebSocket-Security "enabled" always;
    add_header Access-Control-Allow-Origin "https://ainews.production.ai" always;
}

# Report CSP violations (opcional)
# location = /csp-report {
#     if ($request_method = POST) {
#         return 200;
#     }
#     return 405;
# }