# Configuración de Protección DDoS para AI News Aggregator
# Medidas de seguridad contra ataques de denegación de servicio

# Rate Limiting por zona geográfica
geo $country_code {
    default XX;
    include /etc/nginx/geoip.conf;
}

map $country_code $rate_limit {
    default 100;      # 100 requests por minuto por defecto
    US 200;           # Estados Unidos: 200 req/min
    CA 150;           # Canadá: 150 req/min
    EU 150;           # Europa: 150 req/min
    XX 30;            # Países no identificados: 30 req/min
}

# Rate Limiting basado en IP
limit_req_zone $binary_remote_addr zone=global:10m rate=100r/m;
limit_req_zone $binary_remote_addr zone=api:10m rate=50r/m;
limit_req_zone $binary_remote_addr zone=login:10m rate=5r/m;
limit_req_zone $binary_remote_addr zone=search:10m rate=20r/m;

# Rate limiting avanzado por tipo de request
map $request_method $api_rate_limit {
    default 50r/m;
    GET 100r/m;
    POST 20r/m;
    PUT 10r/m;
    DELETE 5r/m;
}

# Bloqueo por User-Agent sospechoso
map $http_user_agent $suspicious_ua {
    default 0;
    ~*(?i)(curl|wget|python|nikto|scan|java|winhttp|clshttp|loader) 1;
    ~*(?i)(%0a|%0d|%27|%3d|%3c|%3e|%00) 1;
    ~*(?i)(?:>|<|%27|%28|%3C|%3E).* 1;
    ~*(?i)(NULLFILE|NULLKEY|HAVIJ|MYSQL|ORACLE|POSTGRES) 1;
    ~*(?i)(script|alert|prompt|onerror|onload|onfocus) 1;
    ~*(?i)(SELECT|DROP|CREATE|UPDATE|DELETE) 1;
}

# Bloqueo por patrones de URL sospechosos
map $request_uri $suspicious_url {
    default 0;
    ~*\.\.(%2e%2e%2f|%2e%2e%2f|%2e%2e) 1;
    ~*(/etc/passwd|/var/log|/proc/self) 1;
    ~*(\.\./\.\./\.\.) 1;
    ~*(%0a|%0d|%27|%3d|%3c|%3e|%00) 1;
    ~*<script 1;
    ~*(alert|prompt|onerror|onload|onfocus) 1;
    ~*(SELECT|DROP|CREATE|UPDATE|DELETE|UNION|INSERT) 1;
    ~*(SCRIPT.*SRC|SCRIPT.*HREF|IFRAME.*SRC) 1;
    ~*(FILE|REMOTE|EXEC|CMD|COMMAND) 1;
}

# Combinación de factores de riesgo
map $suspicious_ua $suspicious_ua_score { default 0; 1 100; }
map $suspicious_url $suspicious_url_score { default 0; 1 100; }
map $http_referer $referrer_score {
    default 0;
    ~*\.ru$ 50;      # Suspechoso de Rusia
    ~*\.cn$ 50;      # Suspechoso de China
    ~*\.tk$ 30;      # Suspechoso de Tonga
    ~*\.ml$ 30;      # Suspechoso de Mali
    ~*\.cf$ 30;      # Suspechoso de República Centroafricana
}

map $suspicious_ua_score $suspicious_url_score $referrer_score $total_risk {
    default 0 0 0 0;
    ~*(\d+) ~*(\d+) ~*(\d+) 0;
}

# Configuración de límites por endpoint
location / {
    limit_req zone=global burst=20 nodelay;
    
    # Bloqueo por User-Agent sospechoso
    if ($suspicious_ua) {
        return 403 "Forbidden: Suspicious User-Agent";
    }
    
    # Bloqueo por URL sospechosa
    if ($suspicious_url) {
        return 403 "Forbidden: Suspicious URL";
    }
    
    # Bloqueo por riesgo total alto
    if ($total_risk > 100) {
        return 429 "Too Many Requests: High Risk Score";
    }
    
    # Proxy al servicio apropiado
    proxy_pass http://frontend;
    include /etc/nginx/proxy.conf;
}

# API endpoints con rate limiting estricto
location /api/ {
    limit_req zone=api burst=10 nodelay;
    
    # Rate limiting por método HTTP
    limit_req zone=api burst=10 nodelay rate=$api_rate_limit;
    
    # Verificaciones adicionales
    if ($suspicious_ua) {
        return 403;
    }
    
    if ($suspicious_url) {
        return 403;
    }
    
    # Proxy al backend
    proxy_pass http://backend;
    include /etc/nginx/proxy.conf;
    
    # Headers de seguridad específicos para API
    add_header API-RateLimit-Limit "50/minute";
    add_header API-RateLimit-Remaining "49";
    add_header API-RateLimit-Reset "60";
}

# Endpoint de login con protección extrema
location ~ ^/(login|auth|signin) {
    limit_req zone=login burst=3 nodelay;
    
    # Bloqueo inmediato si se detecta actividad sospechosa
    if ($suspicious_ua) {
        return 429 "Rate Limited: Suspicious Activity";
    }
    
    # Verificación adicional de referrer
    if ($http_referer ~* ^$) {
        return 403 "Referrer Required";
    }
    
    # Solo permitir POST en endpoints de login
    if ($request_method != POST) {
        return 405 "Method Not Allowed";
    }
    
    proxy_pass http://backend;
    include /etc/nginx/proxy.conf;
}

# Endpoint de búsqueda con rate limiting
location /api/search {
    limit_req zone=search burst=10 nodelay;
    
    # Bloqueo de queries muy largas
    if ($query_string ~* "^.{200,}") {
        return 414 "URI Too Long";
    }
    
    proxy_pass http://backend;
    include /etc/nginx/proxy.conf;
}

# Verificación de tamaño de request
client_body_buffer_size 10K;
client_header_buffer_size 1K;
large_client_header_buffers 2 1K;

# Timeouts para prevenir Slow Loris
client_body_timeout 12;
client_header_timeout 12;
keepalive_timeout 65;
send_timeout 10;

# Headers adicionales de protección DDoS
add_header X-Rate-Limiting "enabled";
add_header X-DDoS-Protection "enabled";
add_header X-Bot-Detection "enabled";

# Reglas específicas por método HTTP
if ($request_method ~* ^(TRACE|TRACK|DEBUG)$) {
    return 405 "Method Not Allowed";
}

# Verificación de encoding
if ($http_accept_encoding ~* gzip) {
    add_header Vary Accept-Encoding;
}

# Proteción contra floods de conexiones
limit_conn_zone $binary_remote_addr zone=conn_limit_per_ip:10m;

location / {
    limit_conn conn_limit_per_ip 20;
    
    # Bloquear conexiones demasiado rápidas
    if ($http_connection ~* ^upgrade$) {
        limit_conn conn_limit_per_ip 5;
    }
}

# Configuración de backup para ataques extremos
# Backup server en caso de overload
upstream backend_backup {
    server 10.0.1.100:8000 max_fails=3 fail_timeout=30s;
}

location / {
    # Si el backend principal falla, usar backup
    proxy_next_upstream error timeout http_500 http_502 http_503 http_504;
    proxy_next_upstream_tries 3;
    proxy_next_upstream_timeout 30s;
}

# Logging especial para ataques
location / {
    # Log específico para requests bloqueados
    access_log /var/log/nginx/ddos-protection.log combined if=$suspicious_ua;
    access_log /var/log/nginx/ddos-protection.log combined if=$suspicious_url;
    
    # Log para requests de alta latencia (posibles Slowloris)
    access_log /var/log/nginx/slowloris.log combined if=$request_time;
}

# Health check endpoint sin rate limiting
location /health {
    access_log off;
    return 200 "healthy\n";
    add_header Content-Type text/plain;
    
    # Permitir muchas conexiones al health check
    limit_conn off;
    limit_req off;
}